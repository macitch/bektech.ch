name: ðŸš€ Deploy Next.js Static Site to Namecheap (FTP)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # ---- Validate required FTP secrets ----
      - name: âœ… Validate required secrets
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_TARGET_DIR: ${{ secrets.FTP_TARGET_DIR }}
        run: |
          missing=()
          req=(FTP_HOST FTP_USERNAME FTP_PASSWORD FTP_TARGET_DIR)
          for v in "${req[@]}"; do [ -z "${!v}" ] && missing+=("$v"); done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Missing secrets: ${missing[*]}"; exit 1
          else
            echo "âœ… FTP secrets present."
          fi

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ› ï¸ Build Next.js static site
        env:
          NEXT_PUBLIC_RESEND_API_KEY: ${{ secrets.NEXT_PUBLIC_RESEND_API_KEY }}
        run: npm run build

      # ---- Add Apache SPA rewrite rules ----
      - name: ðŸ“„ Add .htaccess for SPA routing
        run: |
          cat > out/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteCond %{REQUEST_FILENAME} -f [OR]
            RewriteCond %{REQUEST_FILENAME} -d
            RewriteRule ^ - [L]
            RewriteRule . /index.html [L]
          </IfModule>

          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json
          </IfModule>
          EOF

      # ---- Optional: build marker ----
      - name: ðŸ·ï¸ Write build marker
        run: |
          {
            echo "repo=${GITHUB_REPOSITORY}"
            echo "sha=${GITHUB_SHA}"
            echo "built_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          } > out/version.txt

      # ---- Deploy via FTP ----
      - name: ðŸš€ Deploy to Namecheap via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_TARGET_DIR }}
          local-dir: out/
          dangerous-clean-slate: true
          log-level: verbose